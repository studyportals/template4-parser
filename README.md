# Jison-based parser-generator for Template4

Formalising the Template4-syntax and &dash; perhaps &dash; creating a
production-ready JavaScript-based Template4-parser.

```shell
npm install
npm run build
npm run output
```

The `npm run output` command uses the parser generated by `npm run build` to
output a JSON-representation of a Template4 abstract syntax tree (AST).

The following elements are present:

- type (`t`)
- name (`n`)
- operator (`o`)
- attributes (`a`)
- node children (`c`)
- node data (`d`)

Two test Template4-files are included:

1. `Test.tp4` &ndash; the original test-file used to develop the PHP-based
   Template4-engine about 10 years ago.
2. `New.tp4` &ndash; an updated version of `Test.tp4` to accommodate for
   (backwards-compatible) improvements to the syntax made possible by the new
   lexer/parser approach (changes noted at the start of the file).

To test changes made to the Jison-file, run:

```shell
npm run build
npm run test
```

The `test`- and `output`-scripts are currently hardcoded to using `test/New.tp4`
(and the accompanying `test/New.json` reference output).

## Caveats

- I haven't been able to find a good way of capturing "everything, except for
  the TP4-syntax". The current approach with two patterns &ndash; one capturing
  everything except `{}[]` (the Template4 control-characters) and one capturing
  only `{}[]` &ndash; works just fine from a lexer/parser perspective, but it
  requires some array-manipulation (the first block of JavaScript-logic in the
  language grammar) to prevent spamming the AST with unnecessary HTML-nodes.
- There are two implementations of jison: The
  [original (vanilla) jison](https://github.com/zaach/jison) and
  [jison-gho](https://github.com/GerHobbelt/jison). The Template4 Jison-file is
  compatible (and _should_ aim for compatibility) with both versions. By default
  `jison-gho` is used; use `npm run build:vanilla` to generate a parser using
  the original jison version &ndash; the jury is still out which of the two to
  use for the production-build...
- The `let name1 = $name1; let name2 = $name2;` statement before throwing an
  `Exception` is a workaround for
  [GerHobbelt/jison#22](https://github.com/GerHobbelt/jison/issues/22). Vanilla
  jison doesn't need this workaround (but is not harmed by it either).

## References

1. https://github.com/zaach/jison
2. https://github.com/GerHobbelt/jison
3. http://zaa.ch/jison/docs/
4. http://dinosaur.compilertools.net/bison/index.html
