# Jison-based Parser-generator for Template4

Formalising the [Template4](https://github.com/studyportals/Template4)-syntax
and a &ndash; ðŸ›  work-in-progress &ndash; JavaScript-based
[Template4](https://github.com/studyportals/Template4)-parser.

- [Usage](#usage)
- [Differences with PHP-based implementation](#differences-with-php-based-implementation)
- [Caveats](#caveats)
- [References](#references)

## Usage

```shell
npm install
npm run build
npm run output
```

The `npm run output` command uses the parser generated by `npm run build` to
output a JSON-representation of a Template4 abstract syntax tree (AST).

The following elements are present:

- type (`t`)
- name (`n`)
- operator (`o`)
- attributes (`a`)
- node children (`c`)
- node data (`d`)

To test changes made to the Jison-file, run:

```shell
npm run build
npm run test
```

The `test`- and `output`-scripts are currently hardcoded to using `test/New.tp4`
(and the accompanying `test/New.json` reference output). The test-suite used is
nearly identical to the one provided as a smoke-test for the PHP-based
[Template4](https://github.com/studyportals/Template4) implementation.

## Differences with PHP-based implementation

The Jison-based parser is fully backwards-compatible with the Template4-syntax
used by the PHP-based [Template4](https://github.com/studyportals/Template4)
implementation, with _one_ significant exception:

- Several comparision operator aliasses supported by the PHP-based
  implementation (`greater`, `gt` & `gte` &ndash; `smaller`, `lt` & `lte`
  &ndash; `<>`) have been left out of the Jison-grammar. These aliasses will be
  removed from the PHP-based implementation at its next major revision.

There are also several (non-backwards compatible) enhancements:

- Support for empty quoted strings inside `condition`-statements (e.g. `""`)
  &ndash; in the PHP-based implementation this is only possible by using `false`
  instead of an empty string.
- The closing tag identifier is now optional (when provided, open-tag and
  closing-tag identifiers do still need to match) &ndash; it serves no purpose
  in the Jison-grammar.
- Proper handling of whitespaces and HTML-comments. The old PHP-based parser
  would eat all whitespaces and aggressively mangle HTML-comments. The new
  parser is only concerned with HTML-comments that are part of Template4-tags
  (`<!--[{..}]-->`) and leaves other comments and whitespace untouched.

ðŸ“‹ **TODO**: A second Jison-file (e.g. `template4-compat.jison`) should be
provided that does _not_ allow any of the above enhancements (and perhaps
includes the missing operator aliasses). This should be used when using the
Jison-based parser to validate templates fed into the PHP-based parser.

## Caveats

- I haven't been able to find a good way of capturing "everything, except for
  the TP4-syntax". The current approach with two patterns &ndash; one capturing
  everything except `[{<` (the Template4 opening control-characters) and one
  capturing only `[{<` &ndash; works just fine from a lexer/parser perspective,
  but it requires some array-manipulation (the first block of JavaScript-logic
  in the language grammar) to prevent adding a lot of unnecessary HTML-nodes to
  the AST.
- There are two implementations of jison: The
  [original (vanilla) jison](https://github.com/zaach/jison) and
  [jison-gho](https://github.com/GerHobbelt/jison). The Template4 Jison-file is
  compatible (and _should_ aim for compatibility) with both versions. By default
  `jison-gho` is used; use `npm run build:vanilla` to generate a parser using
  the original jison version &ndash; the jury is still out which of the two to
  use for a possible future production-build...
- The `let name1 = $name1; let name2 = $name2;` statement before throwing an
  `Exception` is a workaround for
  [GerHobbelt/jison#22](https://github.com/GerHobbelt/jison/issues/22). Vanilla
  jison doesn't need this workaround (but is not harmed by it either).
- The `let cwd_X = (typeof cwd === 'undefined' ? yy.cwd : cwd);` statement in
  handling file includes is to deal with the fact that in vanilla jison, context
  arguments are accessed via their name (e.g. `cwd`), but in jison-gho they are
  (apparently) are only available via `yy.cwd`. The variable `_X` part is
  required for the code to remain strict-mode compliant (as the assignments
  happen in the same switch-statement). This one is still open for further
  refinement...

## References

1. https://github.com/zaach/jison
2. https://github.com/GerHobbelt/jison
